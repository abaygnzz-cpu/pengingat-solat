<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Penghitung Kalori & Protein Harian</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card { box-shadow: 0 6px 18px rgba(15,23,42,0.08); border-radius: 16px; }
    .fade-in { animation: fadeIn .45s ease-in; }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    /* small adjustments for charts container */
    canvas { width: 100% !important; height: auto !important; }
  </style>
</head>
<body class="bg-gradient-to-b from-gray-100 to-gray-200 min-h-screen text-gray-900">

  <div class="max-w-5xl mx-auto p-6">
    <div class="bg-white p-6 card fade-in">
      <h1 class="text-2xl font-bold text-center text-blue-700 mb-6">🍱 Penghitung Kalori & Protein Harian</h1>

      <!-- USER DATA -->
      <section class="border-b pb-4 mb-5">
        <h2 class="text-lg font-semibold mb-3">📋 Data Pengguna</h2>
        <div class="grid grid-cols-2 gap-3">
          <select id="gender" class="border p-2 rounded">
            <option value="">Jenis Kelamin</option>
            <option value="pria">Pria</option>
            <option value="wanita">Wanita</option>
          </select>
          <input id="age" type="number" min="0" placeholder="Usia (tahun)" class="border p-2 rounded">
          <input id="weight" type="number" min="0" step="0.1" placeholder="Berat (kg)" class="border p-2 rounded">
          <input id="height" type="number" min="0" step="0.1" placeholder="Tinggi (cm)" class="border p-2 rounded">
        </div>

        <div class="mt-3">
          <select id="activity" class="border rounded w-full p-2 mb-2">
            <option value="">Pilih Aktivitas</option>
            <option value="1.2">Sangat ringan</option>
            <option value="1.375">Ringan (1–3x/minggu)</option>
            <option value="1.55">Sedang (3–5x/minggu)</option>
            <option value="1.725">Berat (6–7x/minggu)</option>
            <option value="1.9">Sangat berat</option>
          </select>

          <select id="goal" class="border rounded w-full p-2">
            <option value="">Pilih Tujuan</option>
            <option value="defisit">Defisit (turun berat)</option>
            <option value="maintenance">Maintenance (stabil)</option>
            <option value="surplus">Surplus (naik berat)</option>
          </select>
        </div>

        <button id="calcBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded w-full font-semibold">
          Hitung Kebutuhan Harian
        </button>

        <div class="text-center mt-3 font-semibold text-blue-700">
          <p id="dailyNeed"></p>
          <p id="proteinNeed" class="text-green-700"></p>
        </div>
      </section>

      <!-- FOOD INPUT -->
      <section>
        <h2 class="text-lg font-semibold mb-2">🥗 Input Makanan</h2>
        <div class="flex gap-2 mb-3">
          <input id="foodName" type="text" placeholder="Nama makanan (misal: nasi goreng)" class="flex-1 border rounded p-2">
          <input id="foodGram" type="number" min="0" placeholder="Gram" class="w-28 border rounded p-2">
          <button id="addBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 rounded font-semibold">+</button>
        </div>

        <ul id="foodList" class="space-y-1 text-sm list-disc list-inside max-h-48 overflow-auto"></ul>

        <div class="text-center mt-4">
          <p class="text-lg font-semibold">Total Kalori: <span id="totalCalories" class="text-blue-700">0</span> kcal</p>
          <p class="text-lg font-semibold">Total Protein: <span id="totalProtein" class="text-green-700">0</span> g</p>
          <p id="status" class="mt-2 text-sm font-semibold"></p>
          <div class="flex justify-center mt-3 gap-3">
            <button id="resetBtn" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded text-sm">Reset Semua</button>
            <button id="exportBtn" class="bg-gray-700 hover:bg-gray-800 text-white py-1 px-3 rounded text-sm">Ekspor (JSON)</button>
            <button id="importBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-3 rounded text-sm">Impor</button>
            <input id="importFile" type="file" accept="application/json" class="hidden">
          </div>
        </div>
      </section>

      <!-- CHARTS -->
      <section class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h2 class="text-lg font-semibold mb-2">📊 Grafik Kalori</h2>
          <canvas id="calorieChart" height="160"></canvas>
        </div>
        <div>
          <h2 class="text-lg font-semibold mb-2">💪 Grafik Protein</h2>
          <canvas id="proteinChart" height="160"></canvas>
        </div>
      </section>

      <p class="mt-4 text-xs text-gray-500">Catatan: nilai kalori/protein adalah estimasi per 100g. Sesuaikan porsi jika perlu.</p>
    </div>
  </div>

  <script>
  /* =========================
     FOOD DATABASE (~100 items)
     values are per 100g: { cal, protein }
     ========================= */
  const foodDB = {
    "nasi putih": { cal: 130, protein: 2.7 }, "nasi goreng": { cal: 180, protein: 4.5 },
    "nasi uduk": { cal: 250, protein: 4 }, "nasi kuning": { cal: 240, protein: 4 },
    "nasi padang": { cal: 260, protein: 6 }, "nasi bakar": { cal: 210, protein: 5 },
    "ayam goreng": { cal: 260, protein: 28 }, "ayam bakar": { cal: 195, protein: 29 },
    "ayam rebus": { cal: 165, protein: 31 }, "ayam geprek": { cal: 280, protein: 27 },
    "dada ayam": { cal: 165, protein: 31 }, "paha ayam": { cal: 210, protein: 25 },
    "ikan tongkol": { cal: 132, protein: 28 }, "ikan tuna": { cal: 132, protein: 28 },
    "ikan salmon": { cal: 208, protein: 20 }, "ikan lele": { cal: 180, protein: 20 },
    "ikan nila": { cal: 100, protein: 20 }, "udang": { cal: 99, protein: 24 },
    "cumi": { cal: 92, protein: 15 }, "kepiting": { cal: 83, protein: 19 },
    "tahu goreng": { cal: 190, protein: 8 }, "tahu kukus": { cal: 76, protein: 8 },
    "tempe goreng": { cal: 200, protein: 11 }, "tempe bacem": { cal: 170, protein: 10 },
    "telur rebus": { cal: 155, protein: 13 }, "telur mata sapi": { cal: 196, protein: 13 },
    "telur dadar": { cal: 200, protein: 12 }, "sate ayam": { cal: 160, protein: 14 },
    "sate kambing": { cal: 200, protein: 18 }, "rendang": { cal: 195, protein: 18 },
    "rawon": { cal: 150, protein: 11 }, "gado-gado": { cal: 180, protein: 8 },
    "ketoprak": { cal: 180, protein: 7 }, "soto ayam": { cal: 120, protein: 9 },
    "soto daging": { cal: 140, protein: 12 }, "bakso sapi": { cal: 180, protein: 9 },
    "bakso ayam": { cal: 150, protein: 10 }, "mie goreng": { cal: 330, protein: 8 },
    "mie rebus": { cal: 280, protein: 7 }, "bakmi": { cal: 300, protein: 10 },
    "kwetiau": { cal: 290, protein: 9 }, "bihun goreng": { cal: 320, protein: 7 },
    "capcay": { cal: 90, protein: 3 }, "sayur asem": { cal: 40, protein: 1.5 },
    "sayur lodeh": { cal: 80, protein: 2 }, "sayur bayam": { cal: 23, protein: 2.9 },
    "tumis kangkung": { cal: 70, protein: 3 }, "tempe orek": { cal: 210, protein: 11 },
    "sop buntut": { cal: 220, protein: 18 }, "nugget ayam": { cal: 290, protein: 12 },
    "burger (daging)": { cal: 295, protein: 17 }, "kentang goreng": { cal: 312, protein: 3.4 },
    "pizza (keju)": { cal: 266, protein: 11 }, "spaghetti": { cal: 158, protein: 5 },
    "roti tawar": { cal: 265, protein: 9 }, "roti isi": { cal: 300, protein: 8 },
    "roti bakar": { cal: 320, protein: 8 }, "bubur ayam": { cal: 120, protein: 7 },
    "lontong": { cal: 100, protein: 2 }, "ketupat": { cal: 96, protein: 2 },
    "sate padang": { cal: 210, protein: 17 }, "pempek": { cal: 220, protein: 11 },
    "siomay": { cal: 120, protein: 10 }, "bakwan": { cal: 150, protein: 3 },
    "pisang goreng": { cal: 260, protein: 3.5 }, "pisang": { cal: 89, protein: 1.1 },
    "apel": { cal: 52, protein: 0.3 }, "jeruk": { cal: 47, protein: 0.9 },
    "alpukat": { cal: 160, protein: 2 }, "mangga": { cal: 60, protein: 0.8 },
    "semangka": { cal: 30, protein: 0.6 }, "melon": { cal: 34, protein: 0.8 },
    "kacang tanah": { cal: 567, protein: 26 }, "kacang mede": { cal: 553, protein: 18 },
    "kacang kedelai": { cal: 446, protein: 36 }, "kacang hijau": { cal: 347, protein: 23 },
    "susu sapi": { cal: 60, protein: 3.2 }, "yoghurt": { cal: 59, protein: 10 },
    "keju": { cal: 350, protein: 25 }, "es teh manis": { cal: 60, protein: 0 },
    "kopi (hitam)": { cal: 2, protein: 0.3 }, "kopi susu": { cal: 50, protein: 1.5 },
    "teh pahit": { cal: 1, protein: 0 }, "air kelapa": { cal: 19, protein: 0.7 },
    "susu kental manis": { cal: 321, protein: 7.6 }, "kue bolu": { cal: 350, protein: 6 },
    "dadar gulung": { cal: 210, protein: 4 }, "klepon": { cal: 220, protein: 1.5 },
    "onde-onde": { cal: 260, protein: 4 }, "risoles": { cal: 280, protein: 6 },
    "tempe mendoan": { cal: 210, protein: 11 }, "sop iga": { cal: 240, protein: 20 },
    "ayam betutu": { cal: 230, protein: 24 }, "coto makassar": { cal: 200, protein: 13 },
    "soto mie": { cal: 250, protein: 10 }
  };

  /* =========================
     STATE (localStorage synced)
     ========================= */
  let totalCalories = +localStorage.getItem('totalCalories') || 0;
  let totalProtein = +localStorage.getItem('totalProtein') || 0;
  let dailyNeed = +localStorage.getItem('dailyNeed') || 0;
  let proteinNeed = +localStorage.getItem('proteinNeed') || 0;
  let foodList = JSON.parse(localStorage.getItem('foodList')) || [];
  let history = JSON.parse(localStorage.getItem('history')) || [];

  const el = id => document.getElementById(id);
  let calorieChart = null, proteinChart = null;

  /* =========================
     UTIL
     ========================= */
  const fmt = n => (typeof n === 'number' ? n.toFixed(1) : n);
  const capitalize = s => (s && s.length ? (s.charAt(0).toUpperCase() + s.slice(1)) : s);

  /* =========================
     INIT
     ========================= */
  window.addEventListener('load', () => {
    // render existing data
    renderList();
    updateDisplay();
    initCharts();

    // attach events
    el('addBtn').addEventListener('click', addFood);
    el('calcBtn').addEventListener('click', calculateNeeds);
    el('resetBtn').addEventListener('click', resetAll);
    el('exportBtn').addEventListener('click', exportJSON);
    el('importBtn').addEventListener('click', () => el('importFile').click());
    el('importFile').addEventListener('change', handleImportFile);

    // keyboard Enter on foodGram or foodName to add quickly
    el('foodGram').addEventListener('keydown', e => { if (e.key === 'Enter') addFood(); });
    el('foodName').addEventListener('keydown', e => { if (e.key === 'Enter') addFood(); });
  });

  /* =========================
     CALCULATE NEEDS
     ========================= */
  function calculateNeeds() {
    const g = el('gender').value;
    const a = parseFloat(el('age').value);
    const w = parseFloat(el('weight').value);
    const h = parseFloat(el('height').value);
    const act = parseFloat(el('activity').value);
    const goal = el('goal').value;

    if (!g || !a || !w || !h || !act || !goal) return alert('Lengkapi semua data pengguna!');

    // Harris-Benedict
    const bmr = g === 'pria'
      ? 88.362 + (13.397 * w) + (4.799 * h) - (5.677 * a)
      : 447.593 + (9.247 * w) + (3.098 * h) - (4.330 * a);

    let tdee = bmr * act;
    if (goal === 'defisit') tdee -= 500;
    if (goal === 'surplus') tdee += 500;
    dailyNeed = Math.round(tdee);
    proteinNeed = Math.round(w * 1.6); // 1.6 g/kg

    localStorage.setItem('dailyNeed', dailyNeed);
    localStorage.setItem('proteinNeed', proteinNeed);

    updateDisplay();
  }

  /* =========================
     ADD FOOD
     ========================= */
  function addFood() {
    const nameRaw = el('foodName').value || '';
    const name = nameRaw.toLowerCase().trim();
    const gram = parseFloat(el('foodGram').value);

    if (!name || !gram || Number.isNaN(gram) || gram <= 0) {
      return alert('Masukkan nama makanan dan jumlah gram yang valid!');
    }
    if (!foodDB[name]) {
      // try gentle match by removing extra spaces or common variations
      const alt = Object.keys(foodDB).find(k => k.includes(name) || name.includes(k));
      if (alt) {
        // map to alt if helpful
        alert(`Makanan dipetakan ke: "${capitalize(alt)}"`);
        return addFoodMapped(alt, gram);
      }
      return alert('Makanan tidak ada di database. Coba ejaan lain (contoh: "nasi goreng").');
    }

    addFoodMapped(name, gram);
  }

  function addFoodMapped(name, gram) {
    const rec = foodDB[name];
    const cal = (rec.cal / 100) * gram;
    const pro = (rec.protein / 100) * gram;

    totalCalories += cal;
    totalProtein += pro;
    foodList.push({ name, gram, cal, pro, time: Date.now() });

    saveData();
    renderList();
    updateDisplay();
    updateCharts();

    el('foodName').value = '';
    el('foodGram').value = '';
  }

  /* =========================
     RENDER & DISPLAY
     ========================= */
  function renderList() {
    el('foodList').innerHTML = foodList.length
      ? foodList.map(f => `<li>${capitalize(f.name)} - ${f.gram}g = ${fmt(f.cal)} kcal / ${fmt(f.pro)} g protein</li>`).join('')
      : '<li class="text-gray-500">Belum ada makanan hari ini.</li>';
  }

  function updateDisplay() {
    el('totalCalories').textContent = fmt(totalCalories);
    el('totalProtein').textContent = fmt(totalProtein);
    el('dailyNeed').textContent = dailyNeed ? `Kebutuhan kalori: ${dailyNeed} kcal` : '';
    el('proteinNeed').textContent = proteinNeed ? `Kebutuhan protein: ${proteinNeed} g` : '';

    if (!dailyNeed) {
      el('status').textContent = '';
      el('status').className = 'mt-2 text-sm font-semibold';
    } else {
      const diff = totalCalories - dailyNeed;
      if (diff < -100) {
        el('status').textContent = '🔥 Masih defisit kalori.';
        el('status').className = 'mt-2 text-sm font-semibold text-green-600';
      } else if (diff > 100) {
        el('status').textContent = '⚠️ Sudah surplus kalori.';
        el('status').className = 'mt-2 text-sm font-semibold text-red-600';
      } else {
        el('status').textContent = '✅ Kalori seimbang (maintenance).';
        el('status').className = 'mt-2 text-sm font-semibold text-blue-600';
      }
    }
  }

  /* =========================
     SAVE / RESET / EXPORT / IMPORT
     ========================= */
  function saveData() {
    localStorage.setItem('foodList', JSON.stringify(foodList));
    localStorage.setItem('totalCalories', totalCalories);
    localStorage.setItem('totalProtein', totalProtein);
    // history stored via updateCharts
  }

  function resetAll() {
    if (!confirm('Yakin ingin mereset semua data?')) return;
    totalCalories = 0; totalProtein = 0; dailyNeed = 0; proteinNeed = 0;
    foodList = []; history = [];
    localStorage.clear();
    renderList(); updateDisplay(); updateCharts(true);
  }

  function exportJSON() {
    const payload = {
      totalCalories, totalProtein, dailyNeed, proteinNeed, foodList, history
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `penghitung-kalori-${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
    };
    reader.readAsText(f);
    evt.target.value = ''; // reset input
  }

  /* =========================
     CHARTS (Chart.js)
     ========================= */
  function initCharts() {
    const today = new Date().toLocaleDateString();
    const last = history[history.length - 1];
    if (!last || last.date !== today) history.push({ date: today, calories: totalCalories, protein: totalProtein });

    const labels = history.map(d => d.date);
    const calData = history.map(d => d.calories);
    const protData = history.map(d => d.protein);

    const ctxC = el('calorieChart').getContext('2d');
    calorieChart = new Chart(ctxC, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Kalori (kcal)',
          data: calData,
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37,99,235,0.15)',
          fill: true,
          tension: 0.25,
          pointRadius: 4
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    const ctxP = el('proteinChart').getContext('2d');
    proteinChart = new Chart(ctxP, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Protein (g)',
          data: protData,
          borderColor: '#16a34a',
          backgroundColor: 'rgba(16,163,74,0.12)',
          fill: true,
          tension: 0.25,
          pointRadius: 4
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    // persist initial history
    localStorage.setItem('history', JSON.stringify(history));
  }

  function updateCharts(reset = false) {
    const today = new Date().toLocaleDateString();
    if (reset) history = [];
    else {
      const idx = history.findIndex(d => d.date === today);
      if (idx >= 0) history[idx] = { date: today, calories: totalCalories, protein: totalProtein };
      else history.push({ date: today, calories: totalCalories, protein: totalProtein });
    }
    localStorage.setItem('history', JSON.stringify(history));

    if (calorieChart && proteinChart) {
      calorieChart.data.labels = history.map(d => d.date);
      calorieChart.data.datasets[0].data = history.map(d => d.calories);
      proteinChart.data.labels = history.map(d => d.date);
      proteinChart.data.datasets[0].data = history.map(d => d.protein);
      calorieChart.update();
      proteinChart.update();
    } else {
      // if charts not initialized yet (edge-case), init them
      initCharts();
    }
  }
  </script>
</body>
</html>
